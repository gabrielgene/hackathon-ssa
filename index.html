<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no">
    <meta charset="utf-8">
    <title>Waypoints in directions</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <!-- Compiled and minified CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.99.0/css/materialize.min.css">

    <style>
      html, body {
        height: 100%;
        margin: 0;
        padding: 0;
      }
      #map {
        height: 100%;
        float: left;
        width: 100%;
      }
      .btn-action-map{
        position: absolute;
        bottom: 20px;
        left: 39%;
        font-size: 19px;
        box-shadow: 0px 0px 17px #000;
      }
      .card-categoria{
        cursor: pointer;
      }
      .card-categoria:hover .thumbnail  {
        background-color: #f4f4f4;
      }
      .modal-dialog{
        #position: relative;
        #top: 40%;
      }
    </style>
  </head>
  <body>
    <nav class="light-blue lighten-1" role="navigation">
      <div class="nav-wrapper container"><a id="logo-container" href="#" class="brand-logo">Eu & Tour</a>
        <ul class="right hide-on-med-and-down">
          <li><a href="#">Navbar Link</a></li>
        </ul>

        <ul id="nav-mobile" class="side-nav">
          <li><a href="#">Navbar Link</a></li>
        </ul>
        <a href="#" data-activates="nav-mobile" class="button-collapse"><i class="material-icons">menu</i></a>
      </div>
    </nav>

    <div class="container" style="height: 100%; width: 100%">
          <div id="map"></div>
          <button type="button" class="btn btn-primary btn-action-map" data-toggle="modal" data-target="#modal-roteiros">Ver Roteiros</button>

          <div id="modal-roteiros" class="modal fade bs-example-modal-lg" tabindex="-1" role="dialog">
            <div class="modal-dialog modal-lg" role="document">
              <div class="modal-content">
                <div class="modal-body">
                  <div class="form-group form-categoria">
                    <label>Qual tipo de passeio você procura?</label>
                    <div class="row">
                      <div class="col-xs-6 col-md-4 card-categoria">
                        <div class="thumbnail">
                          <img src="./assets/images/gastronomia.jpg" alt="...">
                          <div class="caption">
                            <h4>Gastronômico</h4>
                          </div>
                        </div>
                      </div>
                      <div class="col-xs-6 col-md-4 card-categoria">
                        <div class="thumbnail">
                          <img src="./assets/images/cultural.jpg" alt="...">
                          <div class="caption">
                            <h4>Cultural</h4>
                          </div>
                        </div>
                      </div>
                      <div class="col-xs-6 col-md-4 card-categoria">
                        <div class="thumbnail">
                          <img src="./assets/images/historico.jpg" alt="...">
                          <div class="caption">
                            <h4>Histórico</h4>
                          </div>
                        </div>
                      </div>
                      <div class="col-xs-6 col-md-4 card-categoria">
                        <div class="thumbnail">
                          <img src="./assets/images/baladas.jpg" alt="...">
                          <div class="caption">
                            <h4>Baladas</h4>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                  <div class="form-group form-roteiro" style="display: none">
                    <label for="start">Selecione o roteiro</label>
                    <select id="start" class="form-control">
                      <option value="1">Passeio legal</option>
                      <option value="2">Comidas do CHS</option>
                      <option value="3">Bebidas & Baladas</option>
                    </select>
                    <br/><button type="submit" id="submit" class="btn btn-primary">Pronto</button>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div id="modal-qrcode" class="modal fade bs-example-modal-lg" tabindex="-1" role="dialog">
            <div class="modal-dialog modal-lg" role="document">
              <div class="modal-content">
                <div class="modal-header">
                  <p class="title"></p>
                </div>
                <div class="modal-body">
                  <iframe src="camera.html">
                  </iframe>
                </div>
              </div>
            </div>
          </div>
    </div>
    <script>
      var map;
      var start;
      var markers = [];

      function initMap() {
        $(function() {
          $('.button-collapse').sideNav();

          var directionsService = new google.maps.DirectionsService;
          var directionsDisplay = new google.maps.DirectionsRenderer({
            suppressMarkers: true
          });
          map = new google.maps.Map(document.getElementById('map'), {
            zoom: 15,
            center: {lat: -12.9893222, lng: -38.5007595}
          });

          // Try HTML5 geolocation.
          if (navigator.geolocation) {

            navigator.geolocation.getCurrentPosition(function (position) {
              start = {
                lat: position.coords.latitude,
                lng: position.coords.longitude
              };

              var marker = new google.maps.Marker({
                position: start,
                map: map,
                title: 'Estou Aqui'
              });

              map.setCenter(start);
            }, function () {
              handleLocationError(true, infoWindow, map.getCenter());
            });
          } else {
            // Browser doesn't support Geolocation
            handleLocationError(false, infoWindow, map.getCenter());
          }
          directionsDisplay.setMap(map);

          document.getElementById('submit').addEventListener('click', function () {
            $('#modal-roteiros').modal('hide');
            $('.form-categoria').show();
            $('.form-roteiro').hide();
            calculateAndDisplayRoute(directionsService, directionsDisplay);
          });

          $('.card-categoria').on('click', function () {
            $('.form-categoria').hide();
            $('.form-roteiro').show();
          });
        });
      }

      // Sets the map on all markers in the array.
      function setMapOnAll(map) {
        for (var i = 0; i < markers.length; i++) {
          markers[i].setMap(map);
        }
      }

      // Removes the markers from the map, but keeps them in the array.
      function clearMarkers() {
        setMapOnAll(null);
      }

      // Deletes all markers in the array by removing references to them.
      function deleteMarkers() {
        clearMarkers();
        markers = [];
      }

      function calculateAndDisplayRoute(directionsService, directionsDisplay) {
        var waypts_items = [];
        var waypts = [];
        var checkboxArray = document.getElementById('start');
        var end;

        deleteMarkers();

        if (checkboxArray.value == "1") {
          waypts_items = [
                      {name: 'Igreja Nossa Senhora do Rosário dos Pretos', item: {
                        location :{lat: -12.971104, lng: -38.508061}
                      }, stopover: true},
                      {name: 'Igreja e Convento de São Francisco', item: {
                        location :{lat: -12.974375, lng: -38.513061}
                      }, stopover: true}
                   ];
          waypts_items.forEach(function(el){
            waypts.push(el.item)
          });


          end = {
            name: 'Elevador Lacerda',
            location: {
              lat: -12.974190, lng: -38.512865
            }
          }
        }

        var i = 1;
        waypts_items.forEach(function(el){
          var marker = new google.maps.Marker({
            position: el.item.location,
            icon: 'https://chart.googleapis.com/chart?chst=d_map_pin_letter&chld=' + ([i]) + '|FF776B|000000',
            map: map,
            title: el.name
          });
          marker.addListener('click', function() {
            var modal = $('#modal-qrcode');
            modal.find('.title').html(el.name);
            modal.modal('show');
          });
          markers.push(marker);

          i++;
        });

        var marker = new google.maps.Marker({
          position: end.location,
          icon: 'https://chart.googleapis.com/chart?chst=d_map_pin_letter&chld=' + ([i]) + '|FF776B|000000',
          map: map,
          title: end.name
        });
        marker.addListener('click', function() {
          var modal = $('#modal-qrcode');
          modal.find('.title').html(end.name);
          modal.modal('show');
        });
        markers.push(marker);
        console.log(markers);

        directionsService.route({
          origin: start,
          destination: end.location,
          waypoints: waypts,
          optimizeWaypoints: true,
          travelMode: 'WALKING'
        }, function(response, status) {
          if (status === 'OK') {
            directionsDisplay.setDirections(response);
          } else {
            window.alert('Directions request failed due to ' + status);
          }
        });

      }
    </script>
    <script async defer
      src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBdPvSWwm-ICKF1AEK0S48UKvj0FE3sd_U&callback=initMap">
    </script>
    <script
        src="https://code.jquery.com/jquery-3.2.1.min.js"
        integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4="
        crossorigin="anonymous"></script>

    <!-- Compiled and minified JavaScript -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.99.0/js/materialize.min.js"></script>

  </body>
</html>