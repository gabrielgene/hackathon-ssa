<!DOCTYPE html>
<html>

<head>
  <meta name="viewport" content="initial-scale=1.0, user-scalable=no">
  <meta charset="utf-8">
  <title>Waypoints in directions</title>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <!-- Compiled and minified CSS -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.99.0/css/materialize.min.css">

  <style>
    html,
    body {
      height: 100%;
      margin: 0;
      padding: 0;
    }

    #map {
      height: 100%;
      float: left;
      width: 100%;
    }

    .btn-action-map {
      position: absolute;
      bottom: 30px;
      width: 100%;
      text-align: center;
    }

    .card-categoria {
      cursor: pointer;
    }

    .card-categoria:hover .thumbnail {
      background-color: #f4f4f4;
    }

    .modal {
      overflow-y: visible;
    }

    .modal-content {
      height: 100%;
    }

    .frame {
      height: 300px;
      width: 100%;
      border: none;
    }

    .modal-body {
      height: 100%;
    }

    <head><meta name="viewport" content="initial-scale=1.0, user-scalable=no"><meta charset="utf-8"><title>Waypoints in directions</title><link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet"><!-- Compiled and minified CSS --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.99.0/css/materialize.min.css"><style>html,
    body {
      height: 100%;
      margin: 0;
      padding: 0;
    }

    #map {
      height: 100%;
      float: left;
      width: 100%;
    }

    .btn-action-map {
      position: absolute;
      bottom: 30px;
      width: 100%;
      text-align: center;
    }

    .card-categoria {
      cursor: pointer;
    }

    .card-categoria:hover .thumbnail {
      background-color: #f4f4f4;
    }

    .modal {
      overflow-y: visible;
    }

    .modal-content {
      height: 100%;
    }

    .frame {
      height: 100%;
      width: 100%;
      border: none;
    }

    .modal-body {
      height: 100%;
    }
  </style>
</head>

<body>
  <nav class="light-blue lighten-1" role="navigation">
    <div class="nav-wrapper container"><a id="logo-container" href="#" class="brand-logo">Eu & Tour</a>
      <ul id="slide-out" class="side-nav">
        <li>
          <div class="user-view">
            <div class="background">
              <img src="http://www.firstclassbus.com.br/wp-content/uploads/2015/04/Casarios-Centro-Historico-Foto-Rita-Barreto-3454-630x300.jpg">
            </div>
            <a href="#!user"><img class="circle" src="http://materializecss.com/images/yuna.jpg"></a>
            <a href="#!name"><span class="white-text name">Maria Claudia</span></a>
            <a href="#!email"><span class="white-text email">mariaclaudia@gmail.com</span></a>
          </div>
        </li>
        <li><a class="waves-effect" href="#!"><i class="material-icons">room</i>Minhas Rotas</a></li>
        <li>
          <div class="divider"></div>
        </li>
        <li><a class="waves-effect" href="#!"><i class="material-icons">payment</i>Meus Descontos</a></li>
        <li>
          <div class="divider"></div>
        </li>
        <li><a class="waves-effect" href="#!"><i class="material-icons">phone</i>Chamar Guia</a></li>
        <li>
          <div class="divider"></div>
        </li>
        <li><a class="waves-effect" href="#!"><i class="material-icons">settings</i>Configuração</a></li>
        <li>
          <div class="divider"></div>
        </li>
        <li><a class="waves-effect" href="login.html"><i class="material-icons">power_settings_new</i>Sair</a></li>
        <li>
          <div class="divider"></div>
        </li>
      </ul>
      <a href="#" data-activates="slide-out" class="button-collapse"><i class="material-icons">menu</i></a>
      </ul>
    </div>
  </nav>

  <div class="container" style="height: 91%; width: 100%">
    <div id="map"></div>

    <div class="btn-action-map">
      <button id="ver-roteiros" class="waves-effect waves-light btn z-depth-4" data-target="modal-roteiros">Ver Roteiros</button>
      <button id="encerrar-tour" class="waves-effect waves-light btn z-depth-4 red darken-4" data-target="modal-avaliar-tour" style="display: none">Encerrar Tour</button>
    </div>

    <div id="modal-roteiros" class="modal" style="min-height: 301px">
      <div class="modal-content">
        <div class="modal-body">
          <div class="form-group form-categoria">
            <label>Qual tipo de passeio você procura?</label>
            <div class="row">
              <div class="col s3 card-categoria">
                <img src="./assets/images/gastronomia.jpg" class="responsive-img" alt="...">
                <p>Gastronômico</p>
              </div>
              <div class="col s3 card-categoria">
                <img src="./assets/images/cultural.jpg" class="responsive-img" alt="...">
                <p>Cultural</p>
              </div>
              <div class="col s3 card-categoria">
                <img src="./assets/images/historico.jpg" class="responsive-img" alt="...">
                <p>Histórico</p>
              </div>
              <div class="col s3 card-categoria">
                <img src="./assets/images/baladas.jpg" class="responsive-img" alt="...">
                <p>Baladas</p>
              </div>
            </div>
          </div>
        </div>
        <div class="form-group form-roteiro" style="display: none">
          <div class="input-field col s12">
            <select id="start">
                  <option value="" disabled selected>Escolha o Roteiro</option>
                  <option value="1">Passeio legal</option>
                  <option value="2">Comidas do CHS</option>
                  <option value="3">Bebidas & Baladas</option>
                </select>
            <label>Selecione o roteiro</label>
          </div>
          <p class="descricao-roteiro">
          </p>
          <br/><button type="submit" id="submit" class="btn btn-primary">Pronto</button>
        </div>
        <br/><button type="submit" id="submit" class="btn btn-primary">Pronto</button>
      </div>
    </div>
  </div>
  </div>

  <div id="modal-qrcode" class="modal">
    <div class="modal-content">
      <p class="title"></p>
      <div class="modal-body">
        <iframe class="frame" src="camera.html" height="100%" width="100%">
        </iframe>
      </div>
    </div>
  </div>

  <div id="modal-avaliar-tour" class="modal">
    <div class="modal-content">
      <p class="title"></p>
      <div class="modal-body stars">
        <i class="material-icons">stars</i>
        <i class="material-icons">stars</i>
        <i class="material-icons">stars</i>
        <i class="material-icons">stars</i>
        <i class="material-icons">stars</i>
      </div>
    </div>
  </div>
  </div>

  </div>
  <script>
    var map;
    var start;
    var markers = [];

    function initMap() {
      $(function () {
        $('.button-collapse').sideNav();
        $('#modal-roteiros').modal();
        $('#modal-qrcode').modal();
        $('select').material_select();

        var directionsService = new google.maps.DirectionsService;
        var directionsDisplay = new google.maps.DirectionsRenderer({
          suppressMarkers: true
        });
        map = new google.maps.Map(document.getElementById('map'), {
          zoom: 15,
          center: { lat: -12.9893222, lng: -38.5007595 }
        });

        // Try HTML5 geolocation.
        if (navigator.geolocation) {

          navigator.geolocation.getCurrentPosition(function (position) {
            start = {
              lat: position.coords.latitude,
              lng: position.coords.longitude
            };

            var marker = new google.maps.Marker({
              position: start,
              map: map,
              title: 'Estou Aqui'
            });

            document.getElementById('submit').addEventListener('click', function () {
              $('#modal-roteiros').modal('close');
              $('.form-categoria').show();
              $('.form-roteiro').hide();
              $('#ver-roteiros').hide();
              $('#encerrar-tour').show();
              calculateAndDisplayRoute(directionsService, directionsDisplay);
            });
          } else {
          // Browser doesn't support Geolocation
          handleLocationError(false, infoWindow, map.getCenter());
        }
        directionsDisplay.setMap(map);

        $('.card-categoria').on('click', function () {
          $('.form-categoria').hide();
          $('.form-roteiro').show();
        });

        $('#start').on('change', function () {
          var texto = '';

          $('.descricao-roteiro').html(texto);

          if ($(this).val() == '1') {
            texto = "Esse é o passeio legal.<br>Você vai conhecer coisas legais e o Elevador Lacerda.<br>" +
              "Caso queira contratar um guia: Ligue para seu João (71) 99127-2774."
          }

          $('.descricao-roteiro').html(texto);
        });
      });

      $('.card-categoria').on('click', function () {
        $('.form-categoria').hide();
        $('.form-roteiro').show();
      });
    });
    }

    // Sets the map on all markers in the array.
    function setMapOnAll(map) {
      for (var i = 0; i < markers.length; i++) {
        markers[i].setMap(map);
      }
    }

    // Removes the markers from the map, but keeps them in the array.
    function clearMarkers() {
      setMapOnAll(null);
    }

    // Deletes all markers in the array by removing references to them.
    function deleteMarkers() {
      clearMarkers();
      markers = [];
    }

    function calculateAndDisplayRoute(directionsService, directionsDisplay) {
      var waypts_items = [];
      var waypts = [];
      var checkboxArray = document.getElementById('start');
      var end;

      deleteMarkers();

      if (checkboxArray.value == "1") {
        waypts_items = [
          {
            name: 'Igreja Nossa Senhora do Rosário dos Pretos', item: {
              location: { lat: -12.971104, lng: -38.508061 }
            }, stopover: true
          },
          {
            name: 'Igreja e Convento de São Francisco', item: {
              location: { lat: -12.974375, lng: -38.513061 }
            }, stopover: true
          }
        ];
        waypts_items.forEach(function (el) {
          waypts.push(el.item)
        });


        end = {
          name: 'Elevador Lacerda',
          location: {
            lat: -12.974190, lng: -38.512865
          }
        }
      }

      var i = 1;
      waypts_items.forEach(function (el) {
        var marker = new google.maps.Marker({
          position: el.item.location,
          icon: 'https://chart.googleapis.com/chart?chst=d_map_pin_letter&chld=' + ([i]) + '|FF776B|000000',
          map: map,
          title: el.name
        });
        marker.addListener('click', function () {
          var modal = $('#modal-qrcode');
          modal.find('.title').html(el.name);
          modal.modal('open');
        });
        markers.push(marker);

        i++;
      });

      var marker = new google.maps.Marker({
        position: end.location,
        icon: 'https://chart.googleapis.com/chart?chst=d_map_pin_letter&chld=' + ([i]) + '|FF776B|000000',
        map: map,
        title: end.name
      });
      marker.addListener('click', function () {
        var modal = $('#modal-qrcode');
        modal.find('.title').html(end.name);
        modal.modal('open');
      });
      markers.push(marker);
      console.log(markers);

      directionsService.route({
        origin: start,
        destination: end.location,
        waypoints: waypts,
        optimizeWaypoints: true,
        travelMode: 'WALKING'
      }, function (response, status) {
        if (status === 'OK') {
          directionsDisplay.setDirections(response);
        } else {
          window.alert('Directions request failed due to ' + status);
        }
      });

    }
  </script>
  <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBdPvSWwm-ICKF1AEK0S48UKvj0FE3sd_U&callback=initMap">

  </script>
  <script src="https://code.jquery.com/jquery-3.2.1.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4="
    crossorigin="anonymous"></script>

  <!-- Compiled and minified JavaScript -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.99.0/js/materialize.min.js"></script>

</body>

</html>