<!DOCTYPE html>
<html>

<head>
<meta name="viewport" content="initial-scale=1.0, user-scalable=no">
<meta charset="utf-8">
<meta name="mobile-web-app-capable" content="yes">
<title>Eu & Tour</title>
<link rel="icon" type="image/png" href="./assets/images/fav.png" />
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
<!-- Compiled and minified CSS -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.99.0/css/materialize.min.css">

<style>
  html,
  body {
    height: 100%;
    margin: 0;
    padding: 0;
  }

  #map {
    height: 100%;
    float: left;
    width: 100%;
  }

  .btn-action-map {
    position: absolute;
    bottom: 30px;
    width: 100%;
    text-align: center;
  }

  .card-categoria {
    cursor: pointer;
  }

  .card-categoria:hover .thumbnail {
    background-color: #f4f4f4;
  }

  .modal {
    overflow-y: visible;
    max-height: 100%;
  }

  .modal-content {
    height: 100%;
  }

  .frame {
    height: 300px;
    width: 100%;
    border: none;
  }

  .modal-body {
    height: 100%;
  }

  .stars{
    direction: rtl;
    text-align: left;
  }
  .stars i{
    cursor: pointer;
    color: lightgray;
  }
  .stars i:hover, .stars i:hover ~ i, .stars i.selected, .stars i.selected ~ i{
    color: #fec00f;
  }
  .logo-title{
    top: 10px;
    width: 200px;
    position: relative;
    height: 40px;
  }
  nav a {
    color: #d6a22c;
  }
  .btn {
    color: #d6a22c;
  }
</style>
</head>
  <body>
  <nav class="light-blue black" role="navigation">
    <div class="nav-wrapper container"><a id="logo-container" href="#" class="brand-logo"><img class="logo-title" src="./assets/images/logo-horizontal-pelo.png"/></a>
      <ul id="slide-out" class="side-nav">
        <li>
          <div class="user-view">
            <div class="background">
              <img src="http://www.firstclassbus.com.br/wp-content/uploads/2015/04/Casarios-Centro-Historico-Foto-Rita-Barreto-3454-630x300.jpg"/>
            </div>
            <a href="#!user"><img class="circle" src="http://materializecss.com/images/yuna.jpg"></a>
            <a href="#!name"><span class="white-text name">Maria Claudia</span></a>
            <a href="#!email"><span class="white-text email">mariaclaudia@gmail.com</span></a>
          </div>
        </li>
        <li><a class="waves-effect" href="./"><i class="material-icons">location_on</i>Inicio</a></li>
        <li>
          <div class="divider"></div>
        </li>
        <li><a class="waves-effect" href="minhas_rotas.html"><i class="material-icons">list</i>Minhas Rotas</a></li>
        <li>
          <div class="divider"></div>
        </li>
        <li><a class="waves-effect" href="meus_descontos.html"><i class="material-icons">payment</i>Meus Descontos</a></li>
        <li>
          <div class="divider"></div>
        </li>
        <li><a class="waves-effect" href="chamar_guia.html"><i class="material-icons">phone</i>Chamar Guia</a></li>
        <li>
          <div class="divider"></div>
        </li>
        <li><a class="waves-effect" href="#!"><i class="material-icons">settings</i>Configuração</a></li>
        <li>
          <div class="divider"></div>
        </li>
        <li><a class="waves-effect" href="login.html"><i class="material-icons">power_settings_new</i>Sair</a></li>
        <li>
          <div class="divider"></div>
        </li>
      </ul>
      <a href="#" data-activates="slide-out" class="button-collapse"><i class="material-icons">menu</i></a>
      </ul>
    </div>
  </nav>


  <div class="container" style="height: 91%; width: 100%">
    <div id="map"></div>

    <div class="btn-action-map">
      <button id="ver-roteiros" class="waves-effect waves-light btn z-depth-4 black" data-target="modal-roteiros">Ver Roteiros</button>
      <button id="encerrar-tour" class="waves-effect waves-light btn z-depth-4 red darken-4" data-target="modal-avaliar-tour" style="display: none">Encerrar Tour</button>
    </div>

    <div id="modal-roteiros" class="modal" style="min-height: 301px">
      <div class="modal-content">
        <div class="modal-body">
          <div class="form-group form-categoria">
            <h7>Qual tipo de passeio você procura?</h7>
            <div class="row">
              <ul>
                <li>
                  <div class="divider"></div>
                </li>
                <li style="margin-top: 10px" class="card-categoria" data-id="1">
                  <img src="./assets/images/arquitetura.png" style="height: 36px" alt="...">
                </li>
                <li>
                  <div class="divider"></div>
                </li>
                <li style="margin-top: 10px" class="card-categoria" data-id="2">
                  <img src="./assets/images/musica.png" style="height: 36px" alt="...">
                </li>
                <li>
                  <div class="divider"></div>
                </li>
                <li style="margin-top: 10px" class="card-categoria" data-id="3">
                  <img src="./assets/images/religiao.png" style="height: 36px" alt="...">
                </li>
                <li>
                  <div class="divider"></div>
                </li>
                <li style="margin-top: 10px" class="card-categoria" data-id="4">
                  <img src="./assets/images/gastronomia.png" style="height: 36px" alt="...">
                </li>
                <li>
                  <div class="divider"></div>
                </li>
              </ul>
            </div>
          </div>
        </div>
        <div class="form-group form-roteiro" style="display: none">

          <p>
            <input type="checkbox" class="filled-in" id="filled-in-box" />
            <label for="filled-in-box">Sou cadeirante</label>
          </p>
          <div class="input-field col s12">
            <select id="start">
                  <option value="" disabled selected style="display: none">Escolha o Roteiro</option>
                </select>
          </div>
          <p class="descricao-roteiro">
          </p>
          <br/><button type="submit" id="submit" class="btn black" disabled="disabled">Pronto</button>
        </div>
      </div>
    </div>
  </div>
  <div id="modal-qrcode" class="modal">
    <div class="modal-content">
      <h6 class="title"></h6>
      <h7>Para fazer o check-in basta fazer a leitura do QrCode</h7>
      <div class="divider"></div>
      <div class="modal-body">
        <iframe class="frame" src="camera.html" height="100%" width="100%">
        </iframe>
      </div>
    </div>
  </div>

  <div id="modal-avaliar-tour" class="modal bottom-sheet">
    <div class="modal-content">
      <p class="title">Avalie o Tour</p>
      <div class="modal-body stars">
        <i class="material-icons">star</i>
        <i class="material-icons">star</i>
        <i class="material-icons">star</i>
        <i class="material-icons">star</i>
        <i class="material-icons">star</i>
      </div>
      <br /><button class="btn black" id="avaliar-tour">Pronto</button>
    </div>
  </div>

  <script src="https://code.jquery.com/jquery-3.2.1.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4="
          crossorigin="anonymous"></script>

  <!-- Compiled and minified JavaScript -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.99.0/js/materialize.min.js"></script>

  <script>
    var map;
    var start;
    var markers = [];
    var tours = [

    ];

    function initMap() {
      $(function () {
        $('.button-collapse').sideNav();
        $('#modal-roteiros').modal();
        $('#modal-qrcode').modal();
        $('#modal-avaliar-tour').modal();
        $('select').material_select();

        var directionsService = new google.maps.DirectionsService;
        var directionsDisplay = new google.maps.DirectionsRenderer({
          suppressMarkers: true
        });
        map = new google.maps.Map(document.getElementById('map'), {
          zoom: 15,
          center: { lat: -12.9893222, lng: -38.5007595 }
        });

        // Try HTML5 geolocation.
        if (navigator.geolocation) {

          navigator.geolocation.getCurrentPosition(function (position) {
            start = {
              lat: position.coords.latitude,
              lng: position.coords.longitude
            };


            var marker = new google.maps.Marker({
              position: start,
              map: map,
              title: 'Estou Aqui'
            });

            map.setCenter(start);
          });
        } else {
          // Browser doesn't support Geolocation
          handleLocationError(false, infoWindow, map.getCenter());
        }
        directionsDisplay.setMap(map);

        document.getElementById('submit').addEventListener('click', function () {
          $('#modal-roteiros').modal('close');
          $('.form-categoria').show();
          $('.form-roteiro').hide();
          $('#ver-roteiros').hide();
          $('#encerrar-tour').show();
          calculateAndDisplayRoute(directionsService, directionsDisplay);
        });

        $('.card-categoria').on('click', function () {

          $('#start').find('option.delete').remove();
          if($(this).attr('data-id') == '1'){
            $('#start').append('<option class="delete" value="1">Pelourinho e centro histórico</option>' +
                '<option class="delete" value="2">Aventura no Elevador</option>');
          }else if($(this).attr('data-id') == '3'){
            $('#start').append('<option class="delete" value="3">Igrejas do Centro</option>');
          }

          $('select').material_select();

          $('.form-categoria').hide();
          $('.form-roteiro').show();
        });

        $('#start').on('change', function () {
          var texto = '';

          $('.descricao-roteiro').html(texto);

          if ($(this).val() == '1') {
            texto = "Uma visita a Salvador, na Bahia, não pode ser completa sem um tour, mesmo que rápido, pelo Pelourinho. É a oportunidade que o visitante tem de conferir os casarões coloridos, ver a Baía de Todos os Santos, o Mercado Modelo do alto e tirar as clássicas fotos da cidade com o Elevador Lacerda. E é claro, conhecer algumas das igrejas mais bonitas da capital!" +
              "<br>Caso queira contratar um guia: Ligue para seu João (71) 99127-2774."
          }else if ($(this).val() == '2') {
            texto = "O Elevador Lacerda é o primeiro elevador urbano do mundo. Em 8 de dezembro de 1873, quando foi inaugurado, era o mais alto do mundo, com 63 metros." +
                "<br>Caso queira contratar um guia: Ligue para seu João (71) 99127-2774."
          }

          $('.descricao-roteiro').html(texto);

          $('#submit').prop('disabled', false);
        });

        $('.stars').on('click', 'i', function(){
          var parent = $(this).closest('.stars');
          parent.find('i').removeClass('selected');
          $(this).addClass('selected');
        });

        $('#avaliar-tour').on('click', function(){
          // Retrieve the object from storage
          var storage_tours = localStorage.getItem('tours');
          if(storage_tours != null){
            storage_tours = JSON.parse(storage_tours);
          }else{
            storage_tours = [];
          }

          storage_tours.push(
              {
                nome: $('#start').find('option:selected').text(),
                nota: $('.stars i.selected').nextAll().length + 1
              });

          localStorage.setItem('tours', JSON.stringify(storage_tours));

          $('#modal-avaliar-tour').modal('close');
          $('#ver-roteiros').show();
          $('#encerrar-tour').hide();

          deleteMarkers();
        });
      });
    }

    // Sets the map on all markers in the array.
    function setMapOnAll(map) {
      for (var i = 0; i < markers.length; i++) {
        markers[i].setMap(map);
      }
    }

    // Removes the markers from the map, but keeps them in the array.
    function clearMarkers() {
      setMapOnAll(null);
    }

    // Deletes all markers in the array by removing references to them.
    function deleteMarkers() {
      clearMarkers();
      markers = [];
    }

    function calculateAndDisplayRoute(directionsService, directionsDisplay) {
      var waypts_items = [];
      var waypts = [];
      var checkboxArray = document.getElementById('start');
      var end;

      deleteMarkers();

      if (checkboxArray.value == "1") {
        waypts_items = [
          {
            name: 'Igreja Nossa Senhora do Rosário dos Pretos', item: {
              location: { lat: -12.971104, lng: -38.508061 }
            }, stopover: true
          },
          {
            name: 'Igreja e Convento de São Francisco', item: {
              location: { lat: -13.004375, lng: -38.513061 }
            }, stopover: true
          }
        ];
        waypts_items.forEach(function (el) {
          waypts.push(el.item)
        });

        end = {
          name: 'Elevador Lacerda',
          location: {
            lat: -12.974190, lng: -38.512865
          }
        }
      }else if (checkboxArray.value == "2") {
        waypts = []

        end = {
          name: 'Elevador Lacerda',
          location: {
            lat: -12.974190, lng: -38.512865
          }
        }
      }

      var i = 1;
      waypts_items.forEach(function (el) {
        var marker = new google.maps.Marker({
          position: el.item.location,
          //icon: 'https://chart.googleapis.com/chart?chst=d_map_pin_letter&chld=' + ([i]) + '|FF776B|000000',
          icon: './assets/images/' + ([i]) + '.png',
          map: map,
          title: el.name
        });
        marker.addListener('click', function () {
          var modal = $('#modal-qrcode');
          modal.find('.title').html(el.name);
          modal.modal('open');
        });
        markers.push(marker);

        i++;
      });

      var marker = new google.maps.Marker({
        position: end.location,
        //icon: 'https://chart.googleapis.com/chart?chst=d_map_pin_letter&chld=' + ([i]) + '|FF776B|000000',
        icon: './assets/images/' + ([i]) + '.png',
        map: map,
        title: end.name
      });
      marker.addListener('click', function () {
        var modal = $('#modal-qrcode');
        modal.find('.title').html(end.name);
        modal.modal('open');
      });
      markers.push(marker);
      console.log(markers);

      directionsService.route({
        origin: start,
        destination: end.location,
        waypoints: waypts,
        optimizeWaypoints: true,
        travelMode: 'WALKING'
      }, function (response, status) {
        if (status === 'OK') {
          directionsDisplay.setDirections(response);
        } else {
          window.alert('Directions request failed due to ' + status);
        }
      });

    }
  </script>
  <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBdPvSWwm-ICKF1AEK0S48UKvj0FE3sd_U&callback=initMap">

  </script>


</body>

</html>